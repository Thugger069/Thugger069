name: Update Terminal Display
on:
  schedule:
    # Run every 6 hours to keep the terminal fresh
    - cron: '0 */6 * * *'
  # Manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      skip-svg:
        description: 'Skip SVG generation (use existing files)'
        required: false
        default: false
        type: boolean
  # Run when changes are pushed to main branch
  push:
    branches: [ main ]

jobs:
  update-terminal:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # Removed cache to avoid lock file warning since we don't have package.json

      - name: Debug information
        run: |
          echo "üïí Workflow triggered by: ${{ github.event_name }}"
          echo "üéØ Running on branch: ${{ github.ref }}"
          echo "üë§ Triggered by: ${{ github.actor }}"
          echo "üìÅ Workspace: ${{ github.workspace }}"
          echo "üìù Current directory contents:"
          ls -la

      - name: Create necessary directories
        run: |
          mkdir -p dist
          mkdir -p scripts
          mkdir -p backup
          echo "üìÅ Directory structure created"

      - name: Check for existing terminal files
        id: check-files
        run: |
          if [ -f "dist/terminal.svg" ]; then
            echo "terminal-exists=true" >> $GITHUB_OUTPUT
            echo "üìÑ Existing terminal.svg found"
            echo "üìè Size: $(wc -c < dist/terminal.svg) bytes"
          else
            echo "terminal-exists=false" >> $GITHUB_OUTPUT
            echo "‚ùå No existing terminal.svg found"
          fi

      - name: Create enhanced SVG generator script
        run: |
          cat > scripts/generate-terminal-svg.js << 'EOF'
          const fs = require('fs');
          const path = require('path');

          const DIST_DIR = path.resolve(__dirname, '../dist');
          if (!fs.existsSync(DIST_DIR)) fs.mkdirSync(DIST_DIR, { recursive: true });

          const DISPLAY_NAME = "…¨…ß…õ …†ƒ±…¨∆à…ß";
          const GITHUB_USERNAME = "Thugger069";
          const CURRENT_TIME = new Date().toUTCString().replace(/GMT/, 'UTC');

          // Generate random load averages
          const load1 = (Math.random() * 0.8 + 0.1).toFixed(2);
          const load2 = (Math.random() * 0.8 + 0.2).toFixed(2);
          const load3 = (Math.random() * 0.8 + 0.1).toFixed(2);
          const LOAD_AVG = `${load1} ${load2} ${load3}`;

          // Enhanced terminal content
          const lines = [
            `Last login: ${CURRENT_TIME} on ttys001`,
            `${DISPLAY_NAME}@github ~ % whoami`,
            `${DISPLAY_NAME}`,
            '',
            `${DISPLAY_NAME}@github ~ % uname -a`,
            `Darwin github-pro 22.5.0 Darwin Kernel Version 22.5.0: x86_64`,
            '',
            `${DISPLAY_NAME}@github ~ % uptime`,
            `${CURRENT_TIME} up 14 days, 2:51, 1 user, load averages: ${LOAD_AVG}`,
            '',
            `${DISPLAY_NAME}@github ~ % ls -la Projects/`,
            `total 48`,
            `drwxr-xr-x   9 ${DISPLAY_NAME}  staff   288 Jun 15 10:30 .`,
            `drwxr-xr-x   6 ${DISPLAY_NAME}  staff   192 Jun 15 10:30 ..`,
            `drwxr-xr-x   8 ${DISPLAY_NAME}  staff   256 Jun 15 10:30 .git`,
            `-rw-r--r--   1 ${DISPLAY_NAME}  staff   113 Jun 15 10:30 .gitignore`,
            `drwxr-xr-x   7 ${DISPLAY_NAME}  staff   224 Jun 15 10:30 DevOps`,
            `drwxr-xr-x   6 ${DISPLAY_NAME}  staff   192 Jun 15 10:30 OpenSource`,
            `drwxr-xr-x   5 ${DISPLAY_NAME}  staff   160 Jun 15 10:30 Scripts`,
            `-rw-r--r--   1 ${DISPLAY_NAME}  staff  1024 Jun 15 10:30 README.md`,
            `-rw-r--r--   1 ${DISPLAY_NAME}  staff   925 Jun 15 10:30 TODO.md`,
            '',
            `${DISPLAY_NAME}@github ~ % cat Projects/TODO.md`,
            `# üìã Current Projects`,
            `## üöÄ Active Development`,
            `- [ ] Kubernetes cluster autoscaling`,
            `- [ ] Terraform multi-cloud deployment`,
            `- [ ] CI/CD pipeline optimization`,
            `- [ ] Monitoring stack with Prometheus & Grafana`,
            '',
            `## üîÑ Maintenance`,
            `- [ ] Update Docker container security`,
            `- [ ] Backup strategy implementation`,
            '',
            `${DISPLAY_NAME}@github ~ % docker ps`,
            `CONTAINER ID   IMAGE           COMMAND                  STATUS       PORTS     NAMES`,
            `a1b2c3d4e5f6   nginx:alpine    "nginx -g 'daemon off;" Up 2 hours   80/tcp    webserver`,
            `f6e5d4c3b2a1   redis:7-alpine  "docker-entrypoint.s‚Ä¶"  Up 2 hours   6379/tcp  cache`,
            '',
            `${DISPLAY_NAME}@github ~ %`
          ];

          // Cyberpunk theme
          const theme = {
            background: '#1a1b26',
            text: '#c0caf5',
            accent: '#7dcfff',
            border: '#2ac3de',
            headerBg: '#16161e'
          };

          const LINE_HEIGHT = 18;
          const PADDING = 20;
          const height = lines.length * LINE_HEIGHT + PADDING * 2 + 30;
          const maxLineLength = Math.max(...lines.map(line => line.length));
          const CHAR_WIDTH = 8;
          const width = Math.max(800, maxLineLength * CHAR_WIDTH + PADDING * 2);

          const svgDark = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="bgGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="${theme.background}" />
                <stop offset="100%" stop-color="#16161e" />
              </linearGradient>
              <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                <feMerge> 
                  <feMergeNode in="coloredBlur"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>
            
            <!-- Terminal window -->
            <rect width="100%" height="100%" rx="12" ry="12" fill="url(#bgGradient)" 
                  stroke="${theme.border}" stroke-width="2" filter="url(#glow)"/>
            
            <!-- Terminal header -->
            <rect x="0" y="0" width="100%" height="30" rx="12" ry="12" fill="${theme.headerBg}" 
                  stroke="${theme.border}" stroke-width="2"/>
            <circle cx="15" cy="15" r="4" fill="#ff5f56"/>
            <circle cx="30" cy="15" r="4" fill="#ffbd2e"/>
            <circle cx="45" cy="15" r="4" fill="#27ca3f"/>
            <text x="60" y="18" style="font-family: 'Monaco', 'Consolas', monospace; font-size: 12px; fill: ${theme.text}; font-weight: bold;">${DISPLAY_NAME}@github: ~</text>
            
            <style>
              .line { 
                font-family: 'Monaco', 'Consolas', 'Courier New', monospace; 
                font-size: 14px; 
                fill: ${theme.text};
                white-space: pre;
              }
              .accent { 
                fill: ${theme.accent};
                font-weight: bold;
              }
            </style>
            
            <!-- Terminal content -->
            ${lines.map((line, idx) => 
              `<text x="${PADDING}" y="${PADDING + 30 + idx * LINE_HEIGHT}" class="line">${line}</text>`
            ).join('')}
            
            <!-- Blinking cursor -->
            <text x="${PADDING}" y="${PADDING + 30 + (lines.length - 1) * LINE_HEIGHT + 4}" 
                  class="accent">‚ñà
              <animate attributeName="opacity" values="1;0;1" dur="1s" repeatCount="indefinite" />
            </text>
          </svg>`;

          // Light theme variant
          const lightTheme = {
            background: '#ffffff',
            text: '#333333',
            accent: '#0366d6',
            border: '#d1d5da',
            headerBg: '#f6f8fa'
          };

          const svgLight = svgDark
            .replace(new RegExp(theme.background, 'g'), lightTheme.background)
            .replace(new RegExp(theme.text, 'g'), lightTheme.text)
            .replace(new RegExp(theme.accent, 'g'), lightTheme.accent)
            .replace(new RegExp(theme.border, 'g'), lightTheme.border)
            .replace(new RegExp(theme.headerBg, 'g'), lightTheme.headerBg);

          try {
            fs.writeFileSync(path.join(DIST_DIR, 'terminal.svg'), svgDark);
            fs.writeFileSync(path.join(DIST_DIR, 'terminal-light.svg'), svgLight);
            console.log("‚úÖ Enhanced terminal SVGs generated!");
            console.log("üìÅ Files: terminal.svg, terminal-light.svg");
            console.log(`üìè Dimensions: ${width}x${height}px`);
          } catch (error) {
            console.error("‚ùå Error generating SVG files:", error);
            process.exit(1);
          }
          EOF

          echo "üìù SVG generator script created successfully"

      - name: Generate terminal SVGs
        id: generate-svg
        run: |
          if [ "${{ inputs.skip-svg }}" = "true" ] && [ -f "dist/terminal.svg" ]; then
            echo "‚è≠Ô∏è Skipping SVG generation as requested, using existing files"
            echo "svg-generated=false" >> $GITHUB_OUTPUT
          else
            echo "üé® Generating terminal SVGs..."
            if node scripts/generate-terminal-svg.js; then
              echo "‚úÖ SVG generation successful"
              echo "svg-generated=true" >> $GITHUB_OUTPUT
              
              # Display file info
              echo "üìÑ Generated files in dist/:"
              ls -la dist/
              
            else
              echo "‚ùå SVG generation failed"
              echo "svg-generated=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: Create or update README
        id: update-readme
        run: |
          echo "üìñ Updating README.md..."
          
          # GitHub snake URLs
          GITHUB_SNAKE_DARK="https://raw.githubusercontent.com/Thugger069/Thugger069/main/dist/github-snake-dark.svg"
          GITHUB_SNAKE_LIGHT="https://raw.githubusercontent.com/Thugger069/Thugger069/main/dist/github-snake.svg"
          CURRENT_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # Check if README exists and has content
          if [ ! -f "README.md" ] || [ ! -s "README.md" ]; then
            echo "üìù Creating new README.md..."
            cat > README.md << 'README_EOF'
<div align="center">
  <h1>üë®‚Äçüíª …¨…ß…õ …†ƒ±…¨∆à…ß</h1>
  <h3>DevOps Engineer & Open Source Enthusiast</h3>

  <!-- Badges -->
  <p align="center">
    <a href="https://github.com/Thugger069">
      <img src="https://komarev.com/ghpvc/?username=Thugger069&color=blueviolet&style=for-the-badge" alt="Profile Views" />
    </a>
    <a href="https://github.com/Thugger069?tab=followers">
      <img src="https://img.shields.io/github/followers/Thugger069?color=green&logo=github&style=for-the-badge" alt="GitHub Followers" />
    </a>
  </p>
README_EOF
          fi
          
          # Create terminal section
          TERMINAL_SECTION="<!-- Terminal Section -->
  <div align=\"center\">
    <h2>üéÆ Live Terminal</h2>
    <picture>
      <source media=\"(prefers-color-scheme: dark)\" srcset=\"dist/terminal.svg\">
      <source media=\"(prefers-color-scheme: light)\" srcset=\"dist/terminal-light.svg\">
      <img src=\"dist/terminal.svg\" alt=\"Live Terminal Output\" width=\"100%\" style=\"border-radius: 10px; border: 1px solid #2a2b3a; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">
    </picture>
    <br>
    <sub><em>Last updated: $CURRENT_TIME</em></sub>
  </div>"
          
          # Check if terminal section exists and update accordingly
          if grep -q "<!-- Terminal Section -->" README.md; then
            echo "üîÑ Updating existing terminal section..."
            # Create temporary file for processing
            awk -v new_terminal="$TERMINAL_SECTION" '
              /<!-- Terminal Section -->/ { printing=1; print new_terminal; next }
              /<!-- End Terminal Section -->/ { printing=0; next }
              !printing { print }
            ' README.md > README.tmp && mv README.tmp README.md
          else
            echo "üìù Adding new terminal section..."
            echo "" >> README.md
            echo "$TERMINAL_SECTION" >> README.md
          fi
          
          # Add additional sections if they don't exist
          if ! grep -q "<!-- Tech Stack -->" README.md; then
            echo "üõ†Ô∏è Adding tech stack section..."
            cat >> README.md << 'STACK_EOF'

  <!-- Tech Stack -->
  <h2>üõ†Ô∏è Tech Stack</h2>
  <p align="center">
    <img src="https://skillicons.dev/icons?i=linux,docker,kubernetes,aws,bash,python,go,terraform,prometheus,grafana,git,github,gitlab,vscode&perline=7" alt="Tech Stack" />
  </p>
STACK_EOF
          fi

          if ! grep -q "<!-- GitHub Stats -->" README.md; then
            echo "üìä Adding GitHub stats section..."
            cat >> README.md << 'STATS_EOF'

  <!-- GitHub Stats -->
  <h2>üìä GitHub Analytics</h2>
  <p align="center">
    <img height="165" src="https://github-readme-stats.vercel.app/api?username=Thugger069&show_icons=true&theme=radical&hide_border=true&bg_color=1a1b26&title_color=7dcfff&icon_color=bb9af7&text_color=c0caf5" />
    <img height="165" src="https://github-readme-stats.vercel.app/api/top-langs/?username=Thugger069&layout=compact&theme=radical&hide_border=true&bg_color=1a1b26&title_color=7dcfff&text_color=c0caf5" />
  </p>
  
  <p align="center">
    <img src="https://github-readme-streak-stats.herokuapp.com/?user=Thugger069&theme=radical&hide_border=true&background=1a1b26&ring=7dcfff&fire=7dcfff&currStreakLabel=7dcfff" />
  </p>
STATS_EOF
          fi

          if ! grep -q "<!-- GitHub Snake -->" README.md; then
            echo "üêç Adding GitHub snake section..."
            cat >> README.md << 'SNAKE_EOF'

  <!-- GitHub Snake -->
  <h2>üêç GitHub Contributions</h2>
  <p align="center">
    <picture>
      <source media="(prefers-color-scheme: dark)" srcset="$GITHUB_SNAKE_DARK" />
      <source media="(prefers-color-scheme: light)" srcset="$GITHUB_SNAKE_LIGHT" />
      <img alt="GitHub Contribution Snake" src="$GITHUB_SNAKE_LIGHT" width="100%" style="border-radius: 10px;" />
    </picture>
    <br>
    <sub><em>My contribution graph eating my contributions üêç</em></sub>
  </p>
SNAKE_EOF
          fi

          # Close the main div if not closed
          if ! grep -q "^</div>" README.md; then
            echo "üìë Adding closing div and footer..."
            cat >> README.md << 'FOOTER_EOF'

  <!-- Footer -->
  <br>
  <div align="center">
    <sub>‚ö° <b>Last Updated:</b> $CURRENT_TIME | üéØ <b>Always learning, always deploying</b></sub>
    <br>
    <sub>Automatically updated via GitHub Actions</sub>
  </div>
</div>
FOOTER_EOF
          fi

          echo "‚úÖ README.md updated successfully"
          echo "readme-updated=true" >> $GITHUB_OUTPUT

      - name: Verify changes
        run: |
          echo "üîç Verifying changes..."
          echo "üìÑ Files in repository:"
          ls -la
          
          echo "üìÅ Contents of dist/:"
          ls -la dist/ || echo "dist/ directory not found"
          
          echo "üìù README.md status:"
          if [ -f "README.md" ]; then
            echo "‚úÖ README.md exists"
            echo "üìè Size: $(wc -l < README.md) lines"
            echo "üîç First 10 lines:"
            head -10 README.md
          else
            echo "‚ùå README.md missing"
          fi

      - name: Commit and push changes
        if: always()
        run: |
          echo "üöÄ Checking for changes to commit..."
          
          # Configure git
          git config --local user.email "thugger069"
          git config --local user.name "41898282+github-actions[bot]@users.noreply.github.com"                 
          # Check if there are any changes
          if git diff --quiet && git diff --staged --quiet; then
            echo "‚è≠Ô∏è No changes to commit"
          else
            echo "üì¶ Changes detected, preparing commit..."
            
            # Add all changes
            git add .
            
            # Create commit message
            COMMIT_MSG="üîÑ Auto-update terminal display"
            
            if [ "${{ steps.generate-svg.outputs.svg-generated }}" = "true" ]; then
              COMMIT_MSG="$COMMIT_MSG + SVG"
            fi
            
            if [ "${{ steps.update-readme.outputs.readme-updated }}" = "true" ]; then
              COMMIT_MSG="$COMMIT_MSG + README"
            fi
            
            COMMIT_MSG="$COMMIT_MSG ($(date -u +'%Y-%m-%d %H:%M:%S UTC'))"
            
            echo "üíæ Committing: $COMMIT_MSG"
            git commit -m "$COMMIT_MSG"
            
            echo "üì§ Pushing changes..."
            git push
            echo "‚úÖ Changes committed and pushed successfully"
          fi

      - name: Workflow summary
        if: always()
        run: |
          echo ""
          echo "üéâ Workflow Summary"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üë§ Profile: …¨…ß…õ …†ƒ±…¨∆à…ß (Thugger069)"
          echo "üïí Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "üîß SVG Generated: ${{ steps.generate-svg.outputs.svg-generated || 'false' }}"
          echo "üìñ README Updated: ${{ steps.update-readme.outputs.readme-updated || 'false' }}"
          echo "üìÅ Files Modified:"
          git status --porcelain || echo "No git changes"
          echo ""
          echo "üåê View your updated profile:"
          echo "   https://github.com/Thugger069/Thugger069"
          echo ""
          if [ "${{ steps.generate-svg.outputs.svg-generated }}" = "true" ]; then
            echo "‚úÖ Successfully generated enhanced terminal with:"
            echo "   ü™ü Terminal window with controls"
            echo "   üé® Cyberpunk color scheme" 
            echo "   ‚ö° Blinking cursor animation"
            echo "   üåì Dark/light theme support"
          fi
       