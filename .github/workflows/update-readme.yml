name: Update README with Terminal

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      skip-svg:
        description: 'Skip SVG generation'
        required: false
        default: 'false'
  push:
    branches: [ main ]

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Debug info
        run: |
          echo "üïí Trigger: ${{ github.event_name }}"
          echo "üéØ Branch: ${{ github.ref }}"
          echo "üë§ Actor: ${{ github.actor }}"
          ls -la

      - name: Create directories
        run: mkdir -p dist scripts

      - name: Check for SVG generator
        id: check-svg
        run: |
          if [ -f "scripts/generate-terminal-svg.js" ]; then
            echo "script-exists=true" >> $GITHUB_OUTPUT
          else
            echo "script-exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create SVG generator script
        if: steps.check-svg.outputs.script-exists == 'false'
        run: |
          cat > scripts/generate-terminal-svg.js << 'EOF'
          # Paste the full generate-terminal-svg.js content here (optimized script)
          EOF
          chmod +x scripts/generate-terminal-svg.js

      - name: Generate terminal SVGs
        id: generate-svg
        run: |
          SKIP="${{ inputs.skip-svg }}"
          if [ "$SKIP" = "true" ] && [ -f "dist/terminal.svg" ]; then
            echo "svg-generated=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Skipping SVG generation"
          else
            echo "üé® Generating terminal SVGs..."
            if node scripts/generate-terminal-svg.js; then
              echo "‚úÖ SVG generation successful"
              echo "svg-generated=true" >> $GITHUB_OUTPUT
            else
              echo "‚ùå SVG generation failed"
              echo "svg-generated=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: Run update script
        id: update-script
        run: |
          if [ -f "scripts/update-terminal.sh" ]; then
            chmod +x scripts/update-terminal.sh
            ./scripts/update-terminal.sh
            echo "script-completed=true" >> $GITHUB_OUTPUT
          else
            echo "script-completed=false" >> $GITHUB_OUTPUT
          fi

      - name: Manual update fallback
        if: steps.update-script.outputs.script-completed == 'false'
        run: |
          CURRENT_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          # Your manual README update logic here (as before)

      - name: Commit and push changes
        if: always()
        run: |
          git config --local user.name "Thugger069"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --cached --quiet; then
            echo "‚è≠Ô∏è No changes to commit"
          else
            COMMIT_MSG="üîÑ Update terminal display"
            if [ "${{ steps.generate-svg.outputs.svg-generated }}" = "true" ]; then
              COMMIT_MSG="$COMMIT_MSG + SVG"
            fi
            COMMIT_MSG="$COMMIT_MSG ($(date -u +'%Y-%m-%d %H:%M:%S UTC'))"
            git commit -m "$COMMIT_MSG"
            git push

      - name: Workflow summary
        if: always()
        run: |
          echo "üéâ Workflow Complete"
          echo "üîß SVG Generated: ${{ steps.generate-svg.outputs.svg-generated || 'N/A' }}"
          echo "üìñ Update Script: ${{ steps.update-script.outputs.script-completed || 'N/A' }}"