# GitHub Actions Workflow Validator
# This script validates the workflow YAML and checks for common issues

#!/bin/bash

echo "üîç Validating GitHub Actions Workflow"
echo "======================================"
echo ""

WORKFLOW_FILE=".github/workflows/update-readme.yml"
ERRORS=0
WARNINGS=0

# Check if file exists
if [ ! -f "$WORKFLOW_FILE" ]; then
    echo "‚ùå ERROR: Workflow file not found: $WORKFLOW_FILE"
    exit 1
fi

echo "‚úÖ Workflow file exists: $WORKFLOW_FILE"
echo ""

# Validate YAML syntax
echo "1. Validating YAML syntax..."
if python3 -c "import yaml; yaml.safe_load(open('$WORKFLOW_FILE'))" 2>/dev/null; then
    echo "   ‚úÖ YAML syntax is valid"
else
    echo "   ‚ùå YAML syntax error!"
    ((ERRORS++))
fi
echo ""

# Check for required sections
echo "2. Checking workflow structure..."
REQUIRED_SECTIONS=("name:" "on:" "jobs:" "runs-on:" "steps:")

for section in "${REQUIRED_SECTIONS[@]}"; do
    if grep -q "$section" "$WORKFLOW_FILE"; then
        echo "   ‚úÖ Found: $section"
    else
        echo "   ‚ùå Missing: $section"
        ((ERRORS++))
    fi
done
echo ""

# Check for common issues
echo "3. Checking for common issues..."

# Check if token is used correctly in checkout
if grep -q "token:.*secrets.GITHUB_TOKEN" "$WORKFLOW_FILE"; then
    echo "   ‚ö†Ô∏è  WARNING: Using 'token' in checkout step (not needed, GITHUB_TOKEN is auto-provided)"
    ((WARNINGS++))
fi

# Check if actions versions are specified
if grep -q "uses: actions/checkout@v" "$WORKFLOW_FILE"; then
    echo "   ‚úÖ Actions versions are specified"
else
    echo "   ‚ö†Ô∏è  WARNING: Some actions may not have versions"
    ((WARNINGS++))
fi

# Check for required secrets (optional ones)
echo ""
echo "4. Checking for optional secrets usage..."
OPTIONAL_SECRETS=("DEVTO_USERNAME" "LINKEDIN_URL" "TWITTER_HANDLE" "EMAIL_ADDRESS" "WAKATIME_USERNAME")

for secret in "${OPTIONAL_SECRETS[@]}"; do
    if grep -q "secrets.$secret" "$WORKFLOW_FILE"; then
        echo "   ‚ÑπÔ∏è  Uses optional secret: $secret"
    fi
done
echo ""

# Check if scripts exist
echo "5. Checking required scripts..."
REQUIRED_SCRIPTS=("scripts/update-readme.sh")

for script in "${REQUIRED_SCRIPTS[@]}"; do
    if [ -f "$script" ]; then
        if [ -x "$script" ]; then
            echo "   ‚úÖ $script exists and is executable"
        else
            echo "   ‚ö†Ô∏è  $script exists but is not executable (will be fixed in workflow)"
        fi
    else
        echo "   ‚ùå $script not found!"
        ((ERRORS++))
    fi
done
echo ""

# Check optional scripts
OPTIONAL_SCRIPTS=("scripts/terminal_commands.sh")
for script in "${OPTIONAL_SCRIPTS[@]}"; do
    if [ -f "$script" ]; then
        echo "   ‚úÖ Optional: $script exists"
    else
        echo "   ‚ö†Ô∏è  Optional: $script not found (terminal animation step may fail)"
        ((WARNINGS++))
    fi
done
echo ""

# Summary
echo "======================================"
echo "üìä Validation Summary"
echo "======================================"
echo "   Errors: $ERRORS"
echo "   Warnings: $WARNINGS"
echo ""

if [ $ERRORS -eq 0 ]; then
    echo "‚úÖ Workflow validation passed!"
    if [ $WARNINGS -gt 0 ]; then
        echo "‚ö†Ô∏è  Some warnings found, but workflow should work"
    fi
    exit 0
else
    echo "‚ùå Workflow validation failed! Please fix errors above."
    exit 1
fi
